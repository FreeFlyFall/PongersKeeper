<script>

  var target = 21;
  var isP1 = true;
  var isP2 = false;
  
  var player1 = {
    score: 0,
    active: 0
  }
  var player2 = {
    score: 0,
    active: 0
  }
  
  var dbstat = {
    p1IsActive: 0,
    p2IsActive: 0
  }
  
  //handle winning
  
  //window.addEventListener('load', (event) => {
  //  console.log('page is fully loaded');
  //});
  
  /// Initialization for each player based on visit order. Just handled with bool for now.
  google.script.run.withSuccessHandler(setupHandler).initialSetup(dbstat);
  function setupHandler(rdbstat){
      console.log("Initialize me, big boii.");
      if (rdbstat.p2IsActive == 1) {
        isP2 = true;
        isP1 = false;
      } 
      else { console.log("isP1"); }
      console.log('Initialization complete.');
      console.log("P1?: " + isP1 + ", P2?:" + isP2);
    }
  
  /// Score button listener
  document.getElementById("submit").addEventListener("click",function(){
    // Read db for p#active values in gs and return result for eval
    if (isP1 == true) {
      updateScore1(player1);
    } else if (isP2 == true) {
      updateScore2(player2);
    } else {
      console.log("error")
    }
  });
  
  /// Listener to update score in db and js for player 1, and update UI
  function updateScore1(player1){
    google.script.run 
          .withSuccessHandler(function(rPlayer1){
              player1.score = rPlayer1.score;
              console.log('Score1 updated to: ' + player1.score);
              player1.active = rPlayer1.active;
              console.log('p1Active = ' + player1.active);
              document.getElementById("p1Display").innerHTML = player1.score;
          })
          .updateScore1(player1); 
  }
  
  /// Listener to update score in db and js for player 2, and update UI
  function updateScore2(player2){
      google.script.run
          .withSuccessHandler(function(rPlayer2){ 
              player2.score = rPlayer2.score;
              console.log('Score2 updated to: ' + player2.score);
              player2.active = rPlayer2.active;
              console.log('p2Active = ' + player2.active);
              document.getElementById("p2Display").innerHTML = player2.score;
          })
          .updateScore2(player2);
  }
  
  /// OnChange listener to send target score to db, and update local vars/UI
  document.getElementById("target").addEventListener("change",function(e){
    let inputScore = e.target.value
    google.script.run
      .withSuccessHandler(function(updatedScore){
        //set display for target with new score
        console.log(inputScore);
      })
      .setTarget(inputScore);
  })
  
  /// update tick /// still need to test timings
  //turn into one request instead of two
  window.setInterval(function(){
    console.log("tick");
      // update js & ui target score
      google.script.run.withSuccessHandler(function(rtarget){
        console.log("target = " + rtarget);
        target = rtarget
        document.getElementById("target").innerHTML = target;
      }).getTarget();
      // update js score & ui with the opponent score
      if (isP1 == true) {
        console.log("pid = " + pid);
        google.script.run.withSuccessHandler(function(score2){
          player2.Score = score2
          document.getElementById("p2Display").innerHTML = score2;
        }).getPlayer2Score();
      } else if (isP2 == true) {
        console.log("pid = " + pid);
        google.script.run.withSuccessHandler(function(score1){
          player1.Score = score1
          document.getElementById("p1Display").innerHTML = score1;
        }).getPlayer1Score();
      } 
  }, 2000)
    
  /// Reset db on unload of either page
  window.addEventListener('beforeunload', function (e) {
    // the absence of a returnValue property on the event will guarantee the browser unload happens
    google.script.run.resetDB();
    delete e['returnValue'];
  });
  
  //Tell the player which player they are //replace later with username from gscript
  
  </script>